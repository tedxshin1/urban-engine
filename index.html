<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>질병 및 증상 앱</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* 각 결과 컨테이너에 적용될 스타일 */
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .collapsible-content.expanded {
            max-height: 2000px; /* 충분히 큰 값으로 설정하여 내용이 다 보이게 합니다 */
        }
        /* 화살표 아이콘 회전 */
        .toggle-icon.rotated {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-100 to-indigo-200 p-4 min-h-screen">
    <div class="flex flex-col items-center justify-center py-12">
        <div class="bg-white bg-opacity-90 backdrop-filter backdrop-blur-lg rounded-3xl shadow-2xl w-full max-w-2xl p-8 space-y-8 transform transition-transform duration-300">
            <h1 class="text-4xl font-extrabold text-gray-800 text-center tracking-wide">질병 및 증상 앱</h1>

            <!-- 모드 선택 버튼 -->
            <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                <button id="about-button" class="flex-1 px-8 py-3 rounded-full font-bold text-lg transition-all duration-300 bg-blue-600 text-white shadow-lg hover:bg-blue-700 active:scale-95">
                    질병 정보
                </button>
                <button id="symptoms-button" class="flex-1 px-8 py-3 rounded-full font-bold text-lg transition-all duration-300 bg-gray-200 text-gray-700 hover:bg-blue-500 hover:text-white active:scale-95">
                    알 수 없는 증상
                </button>
            </div>

            <!-- 입력 필드와 버튼 -->
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                <input
                    type="text"
                    id="input-field"
                    placeholder="질병 이름을 입력하세요..."
                    class="flex-1 p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-4 focus:ring-blue-300 text-gray-700 text-lg shadow-inner"
                />
                <button
                    id="go-button"
                    class="px-8 py-4 bg-green-500 text-white font-bold rounded-xl shadow-md hover:bg-green-600 transition-all duration-300 active:scale-95 text-lg"
                >
                    찾기
                </button>
            </div>

            <!-- 결과, 로딩, 에러 표시 영역 -->
            <div id="results-container" class="bg-gray-50 p-6 rounded-2xl border border-gray-200 min-h-[300px] flex flex-col items-center justify-center text-center shadow-inner relative">
                <p id="placeholder-text" class="text-gray-400 text-lg">
                    위의 질병 이름을 입력하여 세부 정보를 얻으세요.
                </p>
                <div id="loading-spinner" class="hidden flex-col items-center">
                    <div class="animate-spin rounded-full h-16 w-16 border-4 border-blue-500 border-t-transparent"></div>
                    <p class="mt-4 text-gray-600 text-lg font-medium">생각 중...</p>
                </div>
                <p id="error-message" class="hidden text-red-500 font-bold text-lg"></p>

                <!-- 결과가 동적으로 삽입될 위치 -->
                <div id="dynamic-results-wrapper" class="w-full"></div>
            </div>
        </div>
    </div>

    <script>
        // DOM 요소들을 가져옵니다
        const aboutButton = document.getElementById('about-button');
        const symptomsButton = document.getElementById('symptoms-button');
        const inputField = document.getElementById('input-field');
        const goButton = document.getElementById('go-button');
        const placeholderText = document.getElementById('placeholder-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorMessage = document.getElementById('error-message');
        const dynamicResultsWrapper = document.getElementById('dynamic-results-wrapper');

        // 현재 뷰 상태를 추적합니다: 'about' 또는 'symptoms'
        let currentView = 'about';

        // 하나의 요소를 보여주고 다른 요소는 숨깁니다
        function showElement(element) {
            placeholderText.classList.add('hidden');
            loadingSpinner.classList.add('hidden');
            errorMessage.classList.add('hidden');
            dynamicResultsWrapper.classList.add('hidden');
            element.classList.remove('hidden');
        }
        
        // 현재 뷰에 따라 UI를 업데이트합니다
        function updateView(view) {
            currentView = view;
            if (view === 'about') {
                aboutButton.classList.add('bg-blue-600', 'text-white', 'shadow-lg');
                aboutButton.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-blue-500', 'hover:text-white');
                symptomsButton.classList.remove('bg-blue-600', 'text-white', 'shadow-lg');
                symptomsButton.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-blue-500', 'hover:text-white');
                inputField.placeholder = '질병 이름을 입력하세요...';
                placeholderText.textContent = '위의 질병 이름을 입력하여 세부 정보를 얻으세요.';
            } else {
                symptomsButton.classList.add('bg-blue-600', 'text-white', 'shadow-lg');
                symptomsButton.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-blue-500', 'hover:text-white');
                aboutButton.classList.remove('bg-blue-600', 'text-white', 'shadow-lg');
                aboutButton.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-blue-500', 'hover:text-white');
                inputField.placeholder = '증상을 입력하세요...';
                placeholderText.textContent = '위의 증상을 입력하여 가능한 진단을 받으세요.';
            }
            showElement(placeholderText);
            inputField.value = '';
            // 뷰 변경 시 동적 결과 영역을 비웁니다
            dynamicResultsWrapper.innerHTML = '';
        }

        // 모드 버튼에 이벤트 리스너를 추가합니다
        aboutButton.addEventListener('click', () => updateView('about'));
        symptomsButton.addEventListener('click', () => updateView('symptoms'));

        // Gemini API를 호출하는 함수
        async function callGeminiAPI(prompt) {
            showElement(loadingSpinner);
            goButton.disabled = true;

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const chatHistory = [{
                role: "user",
                parts: [{ text: prompt }]
            }];

            const payload = {
                contents: chatHistory,
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    
                    dynamicResultsWrapper.innerHTML = ''; // 이전 결과 제거
                    dynamicResultsWrapper.classList.remove('hidden');

                    let results;
                    if (currentView === 'about') {
                        // '질병 정보' 모드에서는 전체 응답을 하나의 블록으로 처리
                        results = [text];
                    } else {
                        // '알 수 없는 증상' 모드에서는 각 질병별로 블록을 분리
                        results = text.split(/\n\n(?=1\.|2\.|3\.)/).filter(item => item.trim() !== '');
                    }
                    
                    if (results.length > 0) {
                        results.forEach((item, index) => {
                            let heading;
                            let contentHtml;
                            if(currentView === 'about') {
                                heading = inputField.value.trim();
                                contentHtml = item;
                            } else {
                                const lines = item.split('\n');
                                heading = lines[0].trim();
                                contentHtml = lines.slice(1).join('\n');
                            }
                            
                            // 각 항목을 굵은 글씨로 변경하고, 공백을 추가
                            const formattedContent = contentHtml
                                .replace(/설명:/, '<br><br><b>설명:</b>')
                                .replace(/증상:/, '<br><br><b>증상:</b>')
                                .replace(/치료방법:/, '<br><br><b>치료방법:</b>')
                                .replace(/수술 방법:/, '<br><br><b>수술 방법:</b>')
                                .replace(/수술 후 회복 과정:/, '<br><br><b>수술 후 회복 과정:</b>')
                                .trim();


                            const resultElement = document.createElement('div');
                            resultElement.className = 'w-full flex flex-col mt-4 p-4 border border-gray-300 rounded-lg shadow-sm';
                            resultElement.innerHTML = `
                                <button class="toggle-button flex items-center justify-between w-full px-2 py-2 text-xl font-bold text-left text-gray-700 bg-gray-100 rounded-lg transition-all duration-300 hover:bg-gray-200 focus:outline-none">
                                    <span>${heading}</span>
                                    <svg class="toggle-icon w-8 h-8 transition-transform duration-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                                    </svg>
                                </button>
                                <div class="collapsible-content mt-2">
                                    <div class="prose max-w-none text-left w-full p-4 border-t border-gray-200">
                                        <div class="whitespace-pre-line">${formattedContent}</div>
                                    </div>
                                </div>
                            `;
                            dynamicResultsWrapper.appendChild(resultElement);
                        });

                        // 각 버튼에 이벤트 리스너 추가
                        document.querySelectorAll('.toggle-button').forEach(button => {
                            button.addEventListener('click', (e) => {
                                const content = e.currentTarget.nextElementSibling;
                                const icon = e.currentTarget.querySelector('.toggle-icon');
                                content.classList.toggle('expanded');
                                icon.classList.toggle('rotated');
                            });
                        });

                    } else {
                        // 모호한 증상 또는 일반적인 응답 처리
                         dynamicResultsWrapper.innerHTML = `
                            <div class="w-full flex flex-col p-4">
                                <div class="prose max-w-none text-left w-full">
                                    <div class="whitespace-pre-line">${text}</div>
                                </div>
                            </div>
                        `;
                    }
                    showElement(dynamicResultsWrapper);
                } else {
                    throw new Error("Invalid response from API.");
                }
            } catch (e) {
                console.error("API call error:", e);
                errorMessage.textContent = "데이터를 가져오는 데 실패했습니다. 다시 시도해 주세요.";
                showElement(errorMessage);
            } finally {
                goButton.disabled = false;
            }
        }

        // "찾기" 버튼 클릭 또는 Enter 키를 처리합니다
        function handleGo() {
            const inputValue = inputField.value.trim();
            if (!inputValue) {
                errorMessage.textContent = "텍스트를 입력해 주세요.";
                showElement(errorMessage);
                return;
            }

            let prompt = '';
            if (currentView === 'about') {
                // '질병 정보' 모드 프롬프트
                prompt = `Provide a detailed, organized summary of the disease "${inputValue}" in Korean. Format the response as a single block of text with clear bold headings. Do not use any markdown formatting like * or #. Each heading should be on a new line and the content should follow. Use the following structure, with a blank line between each section:
설명:
[Description]

증상:
[Symptoms]

치료방법:
[Treatment Methods]

If surgery is a treatment option, provide an extensive, university-level, medically technical explanation of the surgical procedure and a detailed explanation of the post-operative recovery process.
수술 방법:
[Extensive, textbook-level, medically technical explanation of the surgical procedure]

수술 후 회복 과정:
[Detailed explanation of the post-operative recovery process]`;
            } else {
                // '알 수 없는 증상' 모드 프롬프트
                prompt = `I am experiencing the following symptom: "${inputValue}". Based on this, please provide a list of the 3 most plausible diseases in Korean. For each disease, provide a brief description of how it relates to the symptom and one or two follow-up questions that could help narrow down the diagnosis. If the symptom is too general to provide a clear diagnosis, you must explicitly state that more information is needed and ask for more specific symptoms. Do not use any markdown formatting like * or #. For each of the three diseases, format the response as follows, with a blank line between each section:
1. [Disease Name]
설명:
[Description]

증상:
[Symptoms]

치료방법:
[Treatment Methods]

If surgery is a treatment option, provide an extensive, university-level, medically technical explanation of the surgical procedure and a detailed explanation of the post-operative recovery process.
수술 방법:
[Extensive, textbook-level, medically technical explanation of the surgical procedure]

수술 후 회복 과정:
[Detailed explanation of the post-operative recovery process]`;
            }
            callGeminiAPI(prompt);
        }

        goButton.addEventListener('click', handleGo);
        inputField.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                handleGo();
            }
        });
        
        // 초기 뷰 설정
        updateView('about');
    </script>
</body>
</html>
